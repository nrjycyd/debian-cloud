name: ğŸš€ Build Debian Cloud Image OVA

on:
  # è§¦å‘å·¥ä½œæµçš„äº‹ä»¶
  push:
    branches:
      - master
      - main
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      debian_version:
        description: 'Debian Version/Codename to build (e.g., bookworm, 12, trixie)'
        required: true
        default: 'bookworm'

jobs:
  build_ova:
    # ä½¿ç”¨æœ€æ–°çš„ Ubuntu Linux ç¯å¢ƒ
    runs-on: ubuntu-latest
    
    # è·å–ç”¨æˆ·åœ¨æ‰‹åŠ¨è§¦å‘æ—¶è¾“å…¥çš„ç‰ˆæœ¬ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤çš„ 'bookworm'
    env:
      TARGET_VERSION: ${{ github.event.inputs.debian_version || 'bookworm' }}

    steps:
      - name: 1. Checkout Repository Code
        uses: actions/checkout@v4
        
      # ç¡®ä¿æ‚¨çš„è„šæœ¬æ–‡ä»¶å­˜åœ¨äºä»“åº“çš„æ ¹ç›®å½•ï¼Œä¾‹å¦‚ï¼šdebian-ova-creator.sh
      - name: 2. Make Script Executable
        run: chmod +x debian-ova-creator.sh

      - name: 3. Install Dependencies (wget & qemu-utils)
        run: |
          echo "Updating system packages and installing dependencies..."
          sudo apt update
          # qemu-utils åŒ…å« qemu-img å·¥å…·
          sudo apt install -y wget qemu-utils

      - name: 4. âš™ï¸ Run OVA Creation Script
        id: run_script
        # æ‰§è¡Œè„šæœ¬ï¼Œä½¿ç”¨ä¼ å…¥çš„ç‰ˆæœ¬å‚æ•°
        run: |
          echo "Starting build for Debian version: $TARGET_VERSION"
          ./debian-ova-creator.sh -d "$TARGET_VERSION"
          
          # è·å–ç”Ÿæˆçš„ OVA æ–‡ä»¶åï¼Œç”¨äºä¸‹ä¸€æ­¥çš„ä¸Šä¼ 
          # æ ¼å¼åº”ä¸ºï¼šdebian-12-genericcloud-amd64.ova (æˆ–ç±»ä¼¼)
          FILE_NAME=$(ls debian-*-genericcloud-amd64.ova)
          echo "Generated OVA file: $FILE_NAME"
          echo "OVA_FILE_NAME=$FILE_NAME" >> $GITHUB_OUTPUT

      - name: 5. â¬†ï¸ Upload Generated OVA as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: debian-${{ env.TARGET_VERSION }}-ova
          # ä½¿ç”¨ä¸Šä¸€æ­¥è·å–åˆ°çš„æ–‡ä»¶å
          path: ${{ steps.run_script.outputs.OVA_FILE_NAME }}
          retention-days: 7
          if-no-files-found: error
          
      - name: 6. Cleanup (Optional)
        if: always()
        run: |
          echo "Build finished successfully."
          # å¯ä»¥åœ¨æ­¤æ·»åŠ åˆ é™¤ä¸‹è½½çš„ qcow2 é•œåƒçš„æ¸…ç†æ­¥éª¤ï¼Œä»¥èŠ‚çœ Runner ç©ºé—´
          # rm -f *.qcow2
