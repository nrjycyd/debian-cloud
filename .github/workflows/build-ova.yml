name: ğŸš€ Build Debian Cloud Image OVA from GitHub URL

on:
  # è§¦å‘å·¥ä½œæµçš„äº‹ä»¶
  push:
    branches:
      - master
      - main
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      debian_version:
        description: 'Debian Version/Codename to build (e.g., bookworm, 12, trixie)'
        required: true
        default: 'bookworm'

jobs:
  build_ova:
    runs-on: ubuntu-latest
    
    env:
      TARGET_VERSION: ${{ github.event.inputs.debian_version || 'bookworm' }}
      # è„šæœ¬çš„ Raw URLï¼Œç”¨äºç›´æ¥ä¸‹è½½æ–‡ä»¶å†…å®¹
      SCRIPT_URL: https://raw.githubusercontent.com/burbuja/debian-ova-creator/master/debian-ova-creator.sh
      SCRIPT_NAME: debian-ova-creator.sh # è„šæœ¬çš„æ–‡ä»¶å

    steps:
      - name: 1. Checkout Repository Code
        # è™½ç„¶æˆ‘ä»¬è¦ä¸‹è½½å¤–éƒ¨è„šæœ¬ï¼Œä½†æœ€å¥½è¿˜æ˜¯æ£€å‡ºä»“åº“ï¼Œä»¥ä¾¿ä¸Šä¼  Artifact
        uses: actions/checkout@v4
        
      - name: 2. Install Dependencies (wget & qemu-utils)
        run: |
          echo "Updating system packages and installing dependencies..."
          sudo apt update
          sudo apt install -y wget qemu-utils

      - name: 3. â¬‡ï¸ Download and Prepare Script
        run: |
          echo "Downloading script from $SCRIPT_URL"
          # ä½¿ç”¨ wget ä¸‹è½½è„šæœ¬åˆ°å½“å‰å·¥ä½œç›®å½•
          wget "$SCRIPT_URL" -O "$SCRIPT_NAME"
          # èµ‹äºˆæ‰§è¡Œæƒé™ï¼Œè§£å†³ä¹‹å‰é‡åˆ°çš„ "No such file or directory" é”™è¯¯
          chmod +x "$SCRIPT_NAME"

      - name: 4. âš™ï¸ Run OVA Creation Script
        id: run_script
        run: |
          echo "Starting build for Debian version: $TARGET_VERSION"
          # æ‰§è¡Œä¸‹è½½å¹¶æˆæƒåçš„è„šæœ¬
          ./"$SCRIPT_NAME" -d "$TARGET_VERSION"
          
          # è·å–ç”Ÿæˆçš„ OVA æ–‡ä»¶åï¼ˆä¾‹å¦‚ debian-12-genericcloud-amd64.ovaï¼‰
          FILE_NAME=$(ls debian-*-genericcloud-amd64.ova)
          echo "Generated OVA file: $FILE_NAME"
          # å°†æ–‡ä»¶åè®¾ç½®ä¸ºè¾“å‡ºå˜é‡ï¼Œä¾›ä¸‹ä¸€æ­¥ä¸Šä¼  Artifact ä½¿ç”¨
          echo "OVA_FILE_NAME=$FILE_NAME" >> $GITHUB_OUTPUT

      - name: 5. â¬†ï¸ Upload Generated OVA as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: debian-${{ env.TARGET_VERSION }}-ova
          path: ${{ steps.run_script.outputs.OVA_FILE_NAME }}
          retention-days: 7
          if-no-files-found: error
          
      - name: 6. Clean up (Optional)
        if: always()
        run: |
          echo "Build finished. Cleaning up intermediate files..."
          # åˆ é™¤ä¸‹è½½çš„ QCOW2 é•œåƒå’Œä¸­é—´æ–‡ä»¶
          rm -f *.qcow2 *.ovf *.mf
